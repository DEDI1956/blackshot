#!/usr/bin/env bash
# ============================================================================
# VPN ALL-IN-ONE TUI PANEL (Ubuntu 20.04 / 22.04)
# Menu Utama - Main Menu
# ============================================================================

# Source library functions
if [[ -f /usr/bin/vpn-lib.sh ]]; then
  # shellcheck disable=SC1091
  source /usr/bin/vpn-lib.sh
else
  echo "ERROR: Library /usr/bin/vpn-lib.sh tidak ditemukan!"
  exit 1
fi

# -----------------------------
# Menu utama
# -----------------------------
print_main_menu() {
  cat <<EOF
${C_BOLD}${C_YELLOW}MAIN MENU${C_RESET}

 [01] SSH MENU
 [02] VMESS MENU
 [03] VLESS MENU
 [04] TROJAN MENU
 [05] AKUN NOOBZVPN
 [06] SS - LIBEV
 [07] INSTALL UDP
 [08] BACKUP / RESTORE
 [09] GOTO X RAM
 [10] RESTART ALL
 [11] TELE BOT
 [12] UPDATE MENU
 [13] RUNNING SERVICE
 [14] INFO PORT
 [15] MENU BOT
 [16] CHANGE DOMAIN
 [17] FIX CERT DOMAIN
 [18] CHANGE BANNER
 [19] RESTART BANNER
 [20] SPEEDTEST
 [21] EKSTRAK MENU

 [00] EXIT
EOF
}

# -----------------------------
# NOOBZVPN (placeholder)
# -----------------------------
noobzvpn_menu() {
  while true; do
    print_header
    render_dashboard

    cat <<EOF
${C_BOLD}${C_YELLOW}AKUN NOOBZVPN${C_RESET}

 [1] Add NOOBZVPN User
 [2] Delete NOOBZVPN User
 [3] List NOOBZVPN Users
 [4] Restart NOOBZVPN Service

 [0] Back

${C_DIM}Placeholder:${C_RESET}
- NOOBZVPN memiliki format akun/config yang berbeda-beda.
- Isi implementasi sesuai binary/service yang Anda gunakan.
EOF

    read -r -p "Select: " opt
    case "$opt" in
      1|2|3)
        echo
        echo "${C_YELLOW}[TODO]${C_RESET} Implementasi NOOBZVPN account management belum tersedia."
        pause
        ;;
      4)
        svc_restart_if_exists noobzvpns
        svc_restart_if_exists noobzvpn
        echo
        echo "${C_GREEN}[OK]${C_RESET} Restart NOOBZVPN (jika service ada)."
        pause
        ;;
      0) return 0 ;;
      *) echo "Pilihan tidak valid."; pause ;;
    esac
  done
}

# -----------------------------
# Shadowsocks-libev (opsional)
# -----------------------------
ss_libev_menu() {
  while true; do
    print_header
    render_dashboard

    cat <<EOF
${C_BOLD}${C_YELLOW}SS - LIBEV${C_RESET}

 [1] Check ss-libev Service Status
 [2] Restart ss-libev

 [0] Back

${C_DIM}Catatan:${C_RESET}
- Jika Anda memakai Shadowsocks via XRAY, gunakan menu XRAY.
- Jika memakai shadowsocks-libev, service biasanya bernama: shadowsocks-libev
EOF

    read -r -p "Select: " opt
    case "$opt" in
      1)
        local st
        st="$(svc_is_active shadowsocks-libev)"
        echo
        echo "shadowsocks-libev: $(fmt_onoff "$st")"
        pause
        ;;
      2)
        svc_restart_if_exists shadowsocks-libev
        echo
        echo "${C_GREEN}[OK]${C_RESET} Restart shadowsocks-libev (jika service ada)."
        pause
        ;;
      0) return 0 ;;
      *) echo "Pilihan tidak valid."; pause ;;
    esac
  done
}

# -----------------------------
# Install UDP Custom (placeholder)
# -----------------------------
udp_install_menu() {
  print_header
  render_dashboard

  cat <<EOF
${C_BOLD}${C_YELLOW}INSTALL UDP (UDP CUSTOM)${C_RESET}

${C_DIM}Placeholder:${C_RESET}
- UDP Custom umumnya membutuhkan binary + konfigurasi port + systemd service.
- Karena implementasi berbeda-beda (udp-custom, badvpn, udp-request, dll),
  script ini tidak menginstall otomatis.

Yang bisa Anda lakukan:
1) Pasang service udp-custom Anda (manual / script installer Anda)
2) Pastikan ada systemd unit bernama: udp-custom / udp-custom-server
3) Dashboard akan otomatis menampilkan status ON/OFF.
EOF
  pause
}

# -----------------------------
# Backup / Restore
# -----------------------------
backup_restore_menu() {
  while true; do
    print_header
    render_dashboard

    cat <<EOF
${C_BOLD}${C_YELLOW}BACKUP / RESTORE${C_RESET}

 [1] Create Backup (tar.gz)
 [2] Restore Backup (tar.gz)

 [0] Back
EOF

    read -r -p "Select: " opt
    case "$opt" in
      1) do_backup ;;
      2) do_restore ;;
      0) return 0 ;;
      *) echo "Pilihan tidak valid."; pause ;;
    esac
  done
}

do_backup() {
  # Backup direktori umum konfigurasi VPN/Reverse Proxy.
  print_header
  echo "${C_BOLD}Create Backup${C_RESET}"
  echo

  local ts out
  ts="$(date +%Y%m%d-%H%M%S)"
  out="/root/vpn-backup-${ts}.tar.gz"

  # Daftar path yang dibackup (yang ada saja).
  local paths=()
  for p in /etc/xray /usr/local/etc/xray /etc/nginx /etc/haproxy /etc/ssh /etc/dropbear /etc/letsencrypt /var/www; do
    [[ -e "$p" ]] && paths+=("$p")
  done

  if [[ ${#paths[@]} -eq 0 ]]; then
    echo "Tidak ada direktori konfigurasi yang ditemukan untuk dibackup."
    pause
    return 0
  fi

  tar -czf "$out" "${paths[@]}" 2>/dev/null || true

  echo "${C_GREEN}[OK]${C_RESET} Backup dibuat: $out"
  echo
  echo "Simpan file ini dengan aman."
  pause
}

do_restore() {
  # Restore backup tar.gz.
  print_header
  echo "${C_BOLD}Restore Backup${C_RESET}"
  echo

  local file
  read -r -p "Path file backup (.tar.gz): " file
  if [[ -z "$file" || ! -f "$file" ]]; then
    echo "File tidak ditemukan."; pause; return 0
  fi

  echo
  echo "${C_YELLOW}[WARN]${C_RESET} Restore akan menimpa konfigurasi yang ada."
  read -r -p "Lanjutkan? (y/N): " yn
  if [[ "${yn,,}" != "y" ]]; then
    echo "Dibatalkan."; pause; return 0
  fi

  tar -xzf "$file" -C / 2>/dev/null || true

  echo
  echo "${C_GREEN}[OK]${C_RESET} Restore selesai."
  echo "Disarankan restart service terkait."
  pause
}

# -----------------------------
# GOTO X RAM (placeholder)
# -----------------------------
goto_x_ram_menu() {
  print_header
  render_dashboard

  cat <<EOF
${C_BOLD}${C_YELLOW}GOTO X RAM${C_RESET}

${C_DIM}Placeholder:${C_RESET}
- Pada beberapa script VPN premium, "X RAM" merujuk ke tool monitoring RAM/
  swap/limiter tertentu atau shortcut ke menu optimasi.
- Anda bisa isi menu ini untuk:
  - install zram
  - set swappiness
  - cache drop
  - monitoring proses pemakaian RAM
EOF
  pause
}

# -----------------------------
# Restart ALL
# -----------------------------
restart_all_menu() {
  print_header
  render_dashboard

  echo "${C_BOLD}${C_YELLOW}RESTART ALL${C_RESET}"
  echo
  echo "Service yang akan dicoba restart: ssh, xray, nginx, haproxy, dropbear, udp-custom, noobzvpn"
  echo
  read -r -p "Lanjutkan? (y/N): " yn
  if [[ "${yn,,}" != "y" ]]; then
    echo "Dibatalkan."; pause; return 0
  fi

  svc_restart_if_exists ssh
  svc_restart_if_exists xray
  svc_restart_if_exists nginx
  svc_restart_if_exists haproxy
  svc_restart_if_exists dropbear
  svc_restart_if_exists udp-custom
  svc_restart_if_exists udp-custom-server
  svc_restart_if_exists noobzvpns
  svc_restart_if_exists noobzvpn

  echo
  echo "${C_GREEN}[OK]${C_RESET} Restart all executed (yang tersedia saja)."
  pause
}

# -----------------------------
# Tele Bot / Menu Bot (placeholder)
# -----------------------------
tele_bot_menu() {
  print_header
  render_dashboard

  cat <<EOF
${C_BOLD}${C_YELLOW}TELE BOT${C_RESET}

${C_DIM}Placeholder:${C_RESET}
- Menu ini biasanya untuk integrasi Telegram Bot:
  - Notifikasi user login
  - Create user via bot
  - Monitor service

Rekomendasi implementasi:
- Simpan BOT_TOKEN dan CHAT_ID di /etc/vpn-panel/telegram.env
- Buat service systemd yang menjalankan bot handler (python/node/bash)
EOF
  pause
}

menu_bot_menu() {
  print_header
  render_dashboard

  cat <<EOF
${C_BOLD}${C_YELLOW}MENU BOT${C_RESET}

${C_DIM}Placeholder:${C_RESET}
- Isi sesuai bot yang Anda gunakan.
- Contoh: start/stop service bot, set token, set chat id.
EOF
  pause
}

# -----------------------------
# Update Menu (placeholder)
# -----------------------------
update_menu() {
  print_header
  render_dashboard

  cat <<EOF
${C_BOLD}${C_YELLOW}UPDATE MENU${C_RESET}

${C_DIM}Placeholder:${C_RESET}
- Mekanisme update biasanya dilakukan via git pull atau download script baru.
- Karena lokasi install tiap VPS berbeda, script ini tidak memaksa update.

Jika Anda menyimpan script ini di /usr/local/sbin/menu, Anda bisa:
- git clone repo Anda -> symlink ke /usr/local/sbin/menu
- atau curl URL raw -> overwrite -> chmod +x
EOF
  pause
}

# -----------------------------
# Running Service
# -----------------------------
running_service_menu() {
  print_header
  render_dashboard

  echo "${C_BOLD}${C_YELLOW}RUNNING SERVICE${C_RESET}"
  echo

  # Tampilkan ringkas service yang relevan.
  local units=(ssh xray nginx haproxy dropbear udp-custom udp-custom-server noobzvpns noobzvpn shadowsocks-libev)
  local u
  for u in "${units[@]}"; do
    local st
    st="$(svc_is_active "$u")"
    printf "%-18s : %s\n" "$u" "$(fmt_onoff "$st")"
  done

  echo
  echo "Detail systemctl (optional):"
  echo "  systemctl --type=service --state=running"
  pause
}

# -----------------------------
# Info Port
# -----------------------------
info_port_menu() {
  print_header
  render_dashboard

  echo "${C_BOLD}${C_YELLOW}INFO PORT${C_RESET}"
  echo

  if command -v ss >/dev/null 2>&1; then
    echo "Listening ports (ss -tulpn):"
    echo
    ss -tulpn || true
  elif command -v netstat >/dev/null 2>&1; then
    echo "Listening ports (netstat -tulpn):"
    echo
    netstat -tulpn || true
  else
    echo "Tool ss/netstat tidak ditemukan. Install paket: iproute2 / net-tools"
  fi

  pause
}

# -----------------------------
# Change Domain
# -----------------------------
change_domain_menu() {
  print_header
  render_dashboard

  echo "${C_BOLD}${C_YELLOW}CHANGE DOMAIN${C_RESET}"
  echo

  local domain
  read -r -p "Masukkan domain baru (contoh: vpn.example.com): " domain
  domain="$(echo "$domain" | tr -d ' \t\r\n')"

  if [[ -z "$domain" ]]; then
    echo "Domain kosong."; pause; return 0
  fi

  # Validasi sederhana (bukan validator DNS penuh).
  if ! [[ "$domain" =~ ^[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]; then
    echo "Format domain terlihat tidak valid."; pause; return 0
  fi

  mkdir -p /etc/xray /etc/v2ray || true
  echo "$domain" > /etc/xray/domain
  echo "$domain" > /etc/v2ray/domain

  echo
  echo "${C_GREEN}[OK]${C_RESET} Domain diset ke: $domain"
  echo "Catatan: Anda mungkin perlu regenerate sertifikat (menu 17) dan reload NGINX/HAPROXY.";
  pause
}

# -----------------------------
# Fix Cert Domain (placeholder dengan guideline)
# -----------------------------
fix_cert_domain_menu() {
  print_header
  render_dashboard

  echo "${C_BOLD}${C_YELLOW}FIX CERT DOMAIN${C_RESET}"
  echo

  local domain
  domain="$(get_domain)"
  echo "Domain saat ini: ${C_CYAN}${domain}${C_RESET}"
  echo

  cat <<EOF
${C_DIM}Placeholder (ACME)${C_RESET}

Sertifikat TLS biasanya dibuat menggunakan salah satu:
- acme.sh (recommended)
- certbot

Contoh alur (acme.sh) secara konsep:
1) Stop service yang memakai port 80 (nginx/haproxy) sementara
2) Issue cert untuk domain
3) Install cert ke lokasi yang dipakai XRAY/NGINX
4) Start ulang service

Karena tiap server bisa berbeda, script ini tidak otomatis mengeksekusi issuance.
EOF

  echo
  if command -v acme.sh >/dev/null 2>&1; then
    echo "acme.sh terdeteksi di PATH. Anda bisa jalankan manual:"
    echo "  acme.sh --issue -d ${domain} --standalone"
    echo "  acme.sh --install-cert -d ${domain} --key-file /etc/xray/xray.key --fullchain-file /etc/xray/xray.crt"
  elif [[ -x /root/.acme.sh/acme.sh ]]; then
    echo "acme.sh terdeteksi di /root/.acme.sh. Anda bisa jalankan manual:"
    echo "  /root/.acme.sh/acme.sh --issue -d ${domain} --standalone"
    echo "  /root/.acme.sh/acme.sh --install-cert -d ${domain} --key-file /etc/xray/xray.key --fullchain-file /etc/xray/xray.crt"
  else
    echo "acme.sh tidak terdeteksi. Jika ingin install:"
    echo "  curl https://get.acme.sh | sh"
  fi

  pause
}

# -----------------------------
# Change Banner (SSH)
# -----------------------------
change_banner_menu() {
  print_header
  render_dashboard

  echo "${C_BOLD}${C_YELLOW}CHANGE BANNER${C_RESET}"
  echo

  local file
  file="/etc/issue.net"

  echo "Banner SSH biasanya mengambil isi file: $file"
  echo
  echo "Masukkan banner baru (akhiri dengan baris tunggal: END)"
  echo "------------------------------------------------------"

  local tmp
  tmp="$(mktemp)"
  while IFS= read -r line; do
    [[ "$line" == "END" ]] && break
    echo "$line" >> "$tmp"
  done

  mv "$tmp" "$file"
  chmod 0644 "$file" || true

  # Pastikan sshd_config mengarah ke /etc/issue.net
  if [[ -f /etc/ssh/sshd_config ]]; then
    if grep -qE '^\s*Banner\s+' /etc/ssh/sshd_config; then
      sed -i 's@^\s*Banner\s\+.*@Banner /etc/issue.net@g' /etc/ssh/sshd_config
    else
      echo 'Banner /etc/issue.net' >> /etc/ssh/sshd_config
    fi
  fi

  echo
  echo "${C_GREEN}[OK]${C_RESET} Banner diupdate. Silakan restart SSH (menu 19) agar efektif."
  pause
}

# -----------------------------
# Restart Banner (restart ssh + dropbear)
# -----------------------------
restart_banner_menu() {
  print_header
  render_dashboard

  echo "${C_BOLD}${C_YELLOW}RESTART BANNER${C_RESET}"
  echo

  svc_restart_if_exists ssh
  svc_restart_if_exists dropbear

  echo "${C_GREEN}[OK]${C_RESET} SSH/Dropbear restart (yang tersedia saja)."
  pause
}

# -----------------------------
# Speedtest
# -----------------------------
speedtest_menu() {
  print_header
  render_dashboard

  echo "${C_BOLD}${C_YELLOW}SPEEDTEST${C_RESET}"
  echo

  if command -v speedtest >/dev/null 2>&1; then
    speedtest || true
    pause
    return 0
  fi

  if command -v speedtest-cli >/dev/null 2>&1; then
    speedtest-cli || true
    pause
    return 0
  fi

  echo "Tool speedtest belum ada. Install cepat via apt:"
  echo "  apt-get update -y && apt-get install -y speedtest-cli"
  echo
  read -r -p "Install sekarang? (y/N): " yn
  if [[ "${yn,,}" == "y" ]]; then
    apt-get update -y
    apt-get install -y speedtest-cli
    speedtest-cli || true
  fi

  pause
}

# -----------------------------
# Ekstrak Menu (placeholder)
# -----------------------------
ekstrak_menu() {
  print_header
  render_dashboard

  cat <<EOF
${C_BOLD}${C_YELLOW}EKSTRAK MENU${C_RESET}

${C_DIM}Placeholder:${C_RESET}
- Pada beberapa panel, menu ini untuk mengekstrak/addon script tambahan.
- Anda bisa isi untuk:
  - import modul menu dari /usr/local/lib/vpn-panel/modules
  - download tambahan (badvpn, stunnel, openvpn tools, dll)
EOF
  pause
}

# -----------------------------
# Main loop input menu (while true)
# -----------------------------
main() {
  require_root

  while true; do
    print_header
    render_dashboard
    print_main_menu

    read -r -p "Select menu: " menu

    case "$menu" in
      1|01) 
        if command -v ssh-menu >/dev/null 2>&1; then
          ssh-menu
        else
          echo "${C_RED}[ERROR]${C_RESET} ssh-menu tidak ditemukan di PATH"
          pause
        fi
        ;;
      2|02) 
        if command -v vmess-menu >/dev/null 2>&1; then
          vmess-menu
        else
          echo "${C_RED}[ERROR]${C_RESET} vmess-menu tidak ditemukan di PATH"
          pause
        fi
        ;;
      3|03) 
        if command -v vless-menu >/dev/null 2>&1; then
          vless-menu
        else
          echo "${C_RED}[ERROR]${C_RESET} vless-menu tidak ditemukan di PATH"
          pause
        fi
        ;;
      4|04) 
        if command -v trojan-menu >/dev/null 2>&1; then
          trojan-menu
        else
          echo "${C_RED}[ERROR]${C_RESET} trojan-menu tidak ditemukan di PATH"
          pause
        fi
        ;;
      5|05) noobzvpn_menu ;;
      6|06) ss_libev_menu ;;
      7|07) udp_install_menu ;;
      8|08) backup_restore_menu ;;
      9|09) goto_x_ram_menu ;;
      10) restart_all_menu ;;
      11) tele_bot_menu ;;
      12) update_menu ;;
      13) running_service_menu ;;
      14) info_port_menu ;;
      15) menu_bot_menu ;;
      16) change_domain_menu ;;
      17) fix_cert_domain_menu ;;
      18) change_banner_menu ;;
      19) restart_banner_menu ;;
      20) speedtest_menu ;;
      21) ekstrak_menu ;;
      0|00)
        echo "Keluar..."
        exit 0
        ;;
      *)
        echo "Pilihan tidak valid.";
        pause
        ;;
    esac
  done
}

main "$@"
