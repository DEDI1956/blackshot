#!/usr/bin/env bash
# ============================================================================
# SSH Menu - Manajemen akun SSH
# ============================================================================

# Source library functions
if [[ -f /usr/bin/vpn-lib.sh ]]; then
  # shellcheck disable=SC1091
  source /usr/bin/vpn-lib.sh
else
  echo "ERROR: Library /usr/bin/vpn-lib.sh tidak ditemukan!"
  exit 1
fi

# -----------------------------
# Sub-menu: SSH
# -----------------------------
ssh_menu() {
  while true; do
    print_header
    render_dashboard

    cat <<EOF
${C_BOLD}${C_YELLOW}SSH MANAGEMENT MENU${C_RESET}

 SERVICE STATUS: $(fmt_onoff "$(svc_is_active ssh)")

 MANAGEMENT OPTIONS:
 [1] Add SSH User
 [2] Delete SSH User
 [3] Renew SSH User (Extend Expiry)
 [4] List SSH Users
 [5] Show Logged-in Users (who)

 [0] Back to Main Menu
EOF

    read -r -p "Select: " opt
    case "$opt" in
      1) ssh_add_user ;;
      2) ssh_delete_user ;;
      3) ssh_renew_user ;;
      4) ssh_list_users ;;
      5) ssh_show_logged_in ;;
      0) return 0 ;;
      *) echo "${C_RED}[ERROR]${C_RESET} Pilihan tidak valid."; pause ;;
    esac
  done
}

ssh_add_user() {
  print_header
  render_dashboard
  
  echo "${C_BOLD}${C_YELLOW}ADD SSH USER${C_RESET}"
  echo

  local user pass days exp_date
  read -r -p "Username: " user
  if [[ -z "$user" ]]; then
    echo "${C_RED}[ERROR]${C_RESET} Username kosong."; pause; return 0
  fi
  if id -u "$user" >/dev/null 2>&1; then
    echo "${C_RED}[ERROR]${C_RESET} User sudah ada."; pause; return 0
  fi

  read -r -s -p "Password: " pass
  echo
  read -r -p "Masa aktif (hari): " days
  if ! [[ "$days" =~ ^[0-9]+$ ]]; then
    echo "${C_RED}[ERROR]${C_RESET} Hari harus angka."; pause; return 0
  fi

  exp_date="$(date -d "+${days} days" +%Y-%m-%d)"

  useradd -m -s /bin/bash -e "$exp_date" "$user" 2>/dev/null || {
    echo "${C_RED}[ERROR]${C_RESET} Gagal membuat user."; pause; return 0
  }
  
  echo "${user}:${pass}" | chpasswd

  echo
  echo "${C_GREEN}[OK]${C_RESET} User berhasil dibuat."
  echo " Username : ${C_CYAN}${user}${C_RESET}"
  echo " Expired  : ${C_CYAN}${exp_date}${C_RESET}"
  pause
}

ssh_delete_user() {
  print_header
  render_dashboard
  
  echo "${C_BOLD}${C_YELLOW}DELETE SSH USER${C_RESET}"
  echo

  local user
  read -r -p "Username: " user
  if [[ -z "$user" ]]; then
    echo "${C_RED}[ERROR]${C_RESET} Username kosong."; pause; return 0
  fi
  if ! id -u "$user" >/dev/null 2>&1; then
    echo "${C_RED}[ERROR]${C_RESET} User tidak ditemukan."; pause; return 0
  fi

  echo "${C_YELLOW}[WARN]${C_RESET} User dan semua data home akan dihapus."
  read -r -p "Lanjutkan? (y/N): " yn
  if [[ "${yn,,}" != "y" ]]; then
    echo "Dibatalkan."; pause; return 0
  fi

  userdel -r "$user" 2>/dev/null || userdel "$user" 2>/dev/null || {
    echo "${C_RED}[ERROR]${C_RESET} Gagal menghapus user."; pause; return 0
  }

  echo
  echo "${C_GREEN}[OK]${C_RESET} User dihapus: ${C_CYAN}${user}${C_RESET}"
  pause
}

ssh_renew_user() {
  print_header
  render_dashboard
  
  echo "${C_BOLD}${C_YELLOW}RENEW SSH USER${C_RESET}"
  echo

  local user days exp_date
  read -r -p "Username: " user
  if [[ -z "$user" ]]; then
    echo "${C_RED}[ERROR]${C_RESET} Username kosong."; pause; return 0
  fi
  if ! id -u "$user" >/dev/null 2>&1; then
    echo "${C_RED}[ERROR]${C_RESET} User tidak ditemukan."; pause; return 0
  fi

  read -r -p "Tambahkan masa aktif (hari): " days
  if ! [[ "$days" =~ ^[0-9]+$ ]]; then
    echo "${C_RED}[ERROR]${C_RESET} Hari harus angka."; pause; return 0
  fi

  # Ambil expiry existing, lalu tambah.
  local cur_exp
  cur_exp="$(chage -l "$user" 2>/dev/null | awk -F: '/Account expires/{gsub(/^ +/,"",$2);print $2}')"

  if [[ "$cur_exp" == "never" || -z "$cur_exp" ]]; then
    exp_date="$(date -d "+${days} days" +%Y-%m-%d)"
  else
    exp_date="$(date -d "${cur_exp} +${days} days" +%Y-%m-%d)"
  fi

  chage -E "$exp_date" "$user" 2>/dev/null || {
    echo "${C_RED}[ERROR]${C_RESET} Gagal mengubah expiry."; pause; return 0
  }

  echo
  echo "${C_GREEN}[OK]${C_RESET} Expiry berhasil diupdate."
  echo " Username : ${C_CYAN}${user}${C_RESET}"
  echo " Expired  : ${C_CYAN}${exp_date}${C_RESET}"
  pause
}

ssh_list_users() {
  print_header
  render_dashboard
  
  echo "${C_BOLD}${C_YELLOW}LIST SSH USERS${C_RESET}"
  echo

  printf "%-20s %-12s\n" "USERNAME" "EXPIRES"
  printf "%-20s %-12s\n" "--------" "-------"

  # Ambil user human dari /etc/passwd.
  while IFS=: read -r uname _ uid _ _ _ shell; do
    [[ "$uid" -ge 1000 ]] || continue
    [[ "$uname" != "nobody" ]] || continue
    [[ "$shell" =~ (nologin|false)$ ]] && continue

    # Expiry via chage.
    local exp
    exp="$(chage -l "$uname" 2>/dev/null | awk -F: '/Account expires/{gsub(/^ +/,"",$2);print $2}')"
    [[ -n "$exp" ]] || exp="-"
    printf "%-20s %-12s\n" "$uname" "$exp"
  done < /etc/passwd

  pause
}

ssh_show_logged_in() {
  print_header
  render_dashboard
  
  echo "${C_BOLD}${C_YELLOW}LOGGED-IN USERS${C_RESET}"
  echo
  who || true
  pause
}

# Main entry point
main() {
  require_root
  ssh_menu
}

main "$@"
